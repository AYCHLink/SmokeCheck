#!/usr/bin/env php
<?php

define('CIGAR_VERSION', '1.2');
$start = microtime(true);

error_reporting(0);

$autoloadLocations = [
    __DIR__ . '/../../../autoload.php',
    __DIR__ . '/../../autoload.php',
    __DIR__ . '/../vendor/autoload.php',
    __DIR__ . '/vendor/autoload.php'
];

foreach ($autoloadLocations as $autoloadFile) {
    if (file_exists($autoloadFile)) {
        require $autoloadFile;
        break;
    }
}

use Brunty\Cigar\AsyncChecker;
use Brunty\Cigar\Outputter;
use Brunty\Cigar\Parser;

array_shift($argv);
$help = in_array('--help', $argv, true);

if($help) {
    $content = <<<HELP

\033[33mUsage:\033[0m
  cigar [options]

\033[33mOptions:\033[0m
      \033[32m--quiet\033[0m                    Do not output any message
      \033[32m--version\033[0m                  Print the version of Cigar 

Created by Matt Brunt
E: matt@mfyu.co.uk
T: twitter.com/Brunty
G: github.com/brunty/cigar

HELP;
    echo $content;
    exit(0);
}

$version = in_array('--version', $argv, true);

if($version) {
    $version = CIGAR_VERSION;
    $content = <<<VERSION
  ____ ___ ____    _    ____  
 / ___|_ _/ ___|  / \  |  _ \ 
| |    | | |  _  / _ \ | |_) |
| |___ | | |_| |/ ___ \|  _ < 
 \____|___\____/_/   \_\_| \_\

\033[0;90;49mThe simple smoke testing tool.\033[0m
 
Version \033[36m{$version}\033[0m

For additional help use \033[36m--help\033[0m


VERSION;
    echo $content;
    exit(0);
}

if( ! file_exists('.cigar.json')) {
    Outputter::writeErrorLine('Could not find .cigar.json file');
    exit(1);
}

$quiet = in_array('--quiet', $argv, true);

try {
    $domains = (new Parser)->parse('.cigar.json');
} catch(\Throwable $e) {
    Outputter::writeErrorLine('Unable to parse .cigar.json file');
    exit(1);
}

$results = (new AsyncChecker())->check($domains);
$outputter = new Outputter($quiet);
$passedResults = $outputter->outputResults($results);

$outputter->outputStats($passedResults, $results, $start);

if ( count($passedResults) !== count($results)) {
    exit(1);
}

exit(0);
